<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera Capture</title>
    <style>
      body{
        box-sizing: border-box;
      }

      #permission-denied-container {
        display: none;
      }

      #camera-container {
        position: relative;
      }
      #capture-btn h6 {
        margin: 0;
      }

      .confirm,
      .retake {
        display: inline-block;
      }
      .confirm h6,
      .retake h6 {
        color: white;
        width: 5vw;
        text-align: left;
      }

      #camera-container,
      #captured-image-container {
          position: relative;
          width: 100%;
          height: 100%;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          margin: 0vh auto !important;
          border-radius: 0 !important;
        }

        #video {
          width: 100vw;
          height: 100vh;
        }

        #video-box {
          position: absolute;
          width: 25vw;
          height: 35vw;
          border-radius: 50%;
          background: transparent;
          box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
          border: 1px dashed lightgray;
          overflow: hidden;
          left: 50%;
          top: 40%;
          transform: translate(-50%, -50%);
        }

        .capture{
          position: absolute;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          top: 100vh;
          left: 50%;
        }

        #capture-btn {
          position: absolute;
          width: 4vw;
          height: 4vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 10vh;
          background-color: #359e7b;
          cursor: pointer;
          
        }

        #confirm-btn {
          position: absolute;
          width: 2vw;
          height: 2vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 4vh;
          background-color: #39c24a;
          cursor: pointer;
        }

        .confirm{
          position: absolute;
          left: 53%;
          bottom: 2vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9;
        }

        .retake{
          position: absolute;
          left: 48%;
          bottom: 2vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9;
        }

        #retake-btn {
          position: absolute;
          width: 2vw;
          height: 2vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 4vh;
          background-color: #d5552f;
          cursor: pointer;
        }

        .capture h6 {
          position: absolute;
          color: white;
          text-align: center;
          font-size: 1.5vw;
          bottom: -1vh;
        }

        .confirm h6{
          position: absolute;
          color: #fff;
          margin-top: 0vh;
          text-align: center;
          font-size: 1vw;
          z-index: 999;
          bottom: -3vh;
        }

        .retake h6 {
          position: absolute;
          color: #fff;
          margin-top: 0vh;
          text-align: center;
          font-size: 1vw;
          bottom: -3vh;
          z-index: 999;
        }

        #controls-container {
          position: absolute;
          top: 85%;
          left: 50%;
          width: 5vw;
        }

        #controls-container h6 {
          color: white;
          margin-top: 2vh;
          text-align: center;
          font-size: 1vw;
          width: 9vw;
        }

        #captured-image-container img {
          max-width: 100%;
          max-height: 100%;
        }
      

        @media only screen and (max-width: 1025px) {
        #camera-container,
        #captured-image-container {
          position: relative;
          width: 100%;
          height: 100%;
          overflow: hidden;
          display: flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
        }

        #video {
          width: 100vw;
          height: 100vh;
        }

        #video-box {
          position: absolute;
          width: 35vw;
          height: 50vw;
          border-radius: 50%;
          background: transparent;
          box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
          border: 1px dashed lightgray;
          overflow: hidden;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
        }

        .capture{
          position: absolute;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          top: 100vh;
          left: 50%;
          gap: 2vh;
        }

        .capture #capture-btn {
          position: absolute;
          width: 5vw;
          height: 5vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 15vh;
          background-color: #359e7b;
          cursor: pointer;
        }

        .confirm #confirm-btn {
          position: absolute;
          width: 5vw;
          height: 5vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 1vh;
          background-color: #39c24a;
          cursor: pointer;
        }

        .confirm{
          position: absolute;
          left: 35%;
          bottom: 4vh;
        }

        .retake{
          position: absolute;
          left: 45%;
          bottom: 4vh;
        }

        .retake #retake-btn {
          position: absolute;
          width: 5vw;
          height: 5vw;
          border-radius: 50%;
          border: 1px dashed #000000;
          bottom: 1vh;
          background-color: #d5552f;
          cursor: pointer;
        }

        .capture h6 {
          position: absolute;
          color: white !important;
          text-align: center;
          font-size: 2vw;
          bottom: 8vh;
        }

        .confirm h6{
          position: absolute;
          color: black;
          margin-top: 5vh;
          text-align: center;
          font-size: 1.5vw;
        }


        .retake h6 {
          position: absolute;
          color: black;
          margin-top: 5vh;
          text-align: center;
          font-size: 1.5vw;
        }

        #controls-container {
          position: absolute;
          top: 80%;
          left: 50%;
          width: 5vw;
        }

        #controls-container h6 {
          color: white;
          margin-top: 3vh;
          text-align: center;
          font-size: 2.5vw;
          width: 18vw;
          font-family: "Arial";
          font-weight: 900;
        }

        #captured-image-container img {
          max-width: 100%;
          max-height: 100%;
          margin-top: 0;
        }

        @media only screen and (max-width: 575px) {
          #camera-container,
          #captured-image-container {
            position: relative;
            width: 100%;
            height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 5vh auto !important;
          }

          #video {
            width: 100vw;
            height: 100vh;
          }

          #video-box {
            position: absolute;
            width: 48vw;
            height: 68vw;
            border-radius: 50%;
            background: transparent;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            border: 1px dashed lightgray;
            overflow: hidden;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
          }

        .capture{
          position: absolute;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          top: 100vh;
          left: 50%;
          z-index: 9999;
        }

          .capture #capture-btn {
            position: absolute;
            width: 10vw;
            height: 10vw;
            border-radius: 50%;
            border: 1px dashed #000000;
            bottom: 15vh;
            background-color: #359e7b;
            cursor: pointer;
          }

          
          .confirm #confirm-btn {
            position: absolute;
            width: 8vw;
            height: 8vw;
            border-radius: 50%;
            border: 1px dashed #000000;
            bottom: 4vh;
            background-color: #39c24a;
            cursor: pointer;
          }

          .confirm{
          position: absolute;
          left: 40%;
          bottom: 2vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          gap: 2vh;
        }

        .retake{
          position: absolute;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          left: 60%;
          bottom: 2vh;
        }

          .retake #retake-btn {
            position: absolute;
            width: 8vw;
            height: 8vw;
            border-radius: 50%;
            border: 1px dashed #000000;
            bottom: 4vh;
            background-color: #d5552f;
            cursor: pointer;
          }

          .capture h6 {
            position: absolute;
            margin-top: 5vh;
            color: white;
            text-align: center;
            font-size: 3.8vw;
            z-index: 9999;
            bottom: 8vh;
            /* margin-left: -3vw; */
          }

          .confirm h6{
            position: absolute;
            color: #fff;
            margin-top: 1vh;
            text-align: center;
            font-size: 3.5vw;
            margin-left: -6vw !important;
            bottom: -3vh;

          }


          .retake h6 {
            color: #fff;
            margin-top: 1vh;
            text-align: center;
            font-size: 3.5vw;
            margin-left: -4vw;
            bottom: -3vh;
          }

          #controls-container {
            position: absolute;
            top: 85%;
            left: 50%;
            width: 5vw;
          }

          #captured-image-container img {
            max-width: 100%;
            max-height: 100%;
          }
        }

        
      }
    </style>
  </head>
  <body>
    <section id="permission-denied-container">
      <p>Camera access denied.</p>
      <p>
        To enable camera access, please go to your browser settings and allow
        camera access for this site.
      </p>
      <button style="background:#359e7b;cursor:grab" onClick="CameraCaptureModule.startCamera()">Access Camera</button>
    </section>

    <main id='parent-camera-container'>
    <section id="camera-container">
      <video id="video" autoplay></video>
      <div class="capture">
        <button id="capture-btn"></button>
        <h6>Capture</h6>
      </div>
      
    </section>

    <section id="captured-image-container" style="display: none;text-align:center">
      <img id="captured-image" src="" alt="Captured Image" />
      <div class="confirm">
        <button id="confirm-btn"></button>
        <h6>Confirm</h6>
      </div>
      <div class="retake">
        <button id="retake-btn"></button>
        <h6>Retake</h6>
      </div>
    </section>
  </main>



    <script>
      const confirmAction = function (imgSrc) {
        alert("custom confirm action working");
      };

      overlayOptions = {
        display: true,
        color: "green",
      };
      

      const CameraCaptureModule = (function () {
        // Private variables and functions
        let videoContainer,
          video,
          captureBtn,
          capturedImageContainer,
          capturedImage,
          confirmBtn,
          retakeBtn,
          permissionDeniedContainer,
          parentCameraContainer,
          stream,
          confirmAction;

        const overlayHTML = '<div id="video-box"></div>';

        let showOverlay = true;
        let overlayColor = "rgb(0,0,0,0.5)";

        function getElements() {
          videoContainer = document.getElementById("camera-container");
          video = document.getElementById("video");
          captureBtn = document.getElementById("capture-btn");
          capturedImageContainer = document.getElementById(
            "captured-image-container"
          );
          capturedImage = document.getElementById("captured-image");
          confirmBtn = document.getElementById("confirm-btn");
          retakeBtn = document.getElementById("retake-btn");
          permissionDeniedContainer = document.getElementById(
            "permission-denied-container"
          );
          parentCameraContainer  = document.getElementById("parent-camera-container");
        }

        async function startCamera() {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            if(permissionDeniedContainer.style.display === 'block'){
              permissionDeniedContainer.style.display = 'none'
            }
            if(parentCameraContainer.style.display === 'none'){
              parentCameraContainer.style.display = 'block'
            }
          } catch (error) {
            console.error("Error accessing camera:", error);
            permissionDeniedContainer.style.display = "block";
            parentCameraContainer.style.display = "none";
          }
        }

        function captureImage(event) {
          event.preventDefault();
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext("2d").drawImage(video, 0, 0);
          const imageData = canvas.toDataURL("image/png");
          capturedImage.src = imageData;
          videoContainer.style.display = "none";
          capturedImageContainer.style.display = "block";
          stopCamera();
        }

        function retakePicture(event) {
          event.preventDefault();
          startCamera();
          videoContainer.style.display = "block";
          capturedImageContainer.style.display = "none";
        }

        function stopCamera() {
          if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
          }
        }

        function updateOverlay() {
          const overlay = document.getElementById("video-box");
          if (showOverlay) {
            if (!overlay) {
              videoContainer.insertAdjacentHTML("afterbegin", overlayHTML);
            }
          } else {
            if (overlay) {
              overlay.remove();
            }
          }
        }

        function updateOverlayColor() {
          const overlay = document.getElementById("video-box");
          if (overlay) {
            overlay.style.boxShadow = `0 0 0 1000px ${overlayColor}`;
          }
        }

        function handleConfirm() {
          if(capturedImage.src){
            copyBase64ImageToClipboard(capturedImage.src);
          }
          if (
            confirmAction != undefined &&
            confirmAction != null &&
            capturedImage != null
          ) {
            confirmAction(capturedImage.src);
          }
        }

        async function copyBase64ImageToClipboard(base64Image) {
          try {
            const response = await fetch(base64Image);
            console.log(response, "response");
            const blob = await response.blob();
            console.log(blob, "blob");

            await navigator.clipboard.write([
              new ClipboardItem({
                [blob.type]: blob,
              }),
            ]);
            console.log("Base64 image copied to clipboard!");
          } catch (err) {
            console.error("Failed to copy base64 image: ", err);
          }
        }

        async function getBase64ImageFromClipboard() {
          try {
            const clipboardItems = await navigator.clipboard.read();
            for (const clipboardItem of clipboardItems) {
              for (const type of clipboardItem.types) {
                if (type.startsWith("image/")) {
                  const blob = await clipboardItem.getType(type);
                  return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = function () {
                      resolve(reader.result);
                    };
                    reader.onerror = function (err) {
                      reject(err);
                    };
                    reader.readAsDataURL(blob);
                  });
                }
              }
            }
            return null; // No image found in the clipboard
          } catch (err) {
            console.error("Failed to read clipboard: ", err);
            return null;
          }
        }

        function getImage() {
          getBase64ImageFromClipboard()
            .then((base64data) => {
              if (base64data) {
                console.log("Retrieved base64 image:", base64data);
                // Do something with the base64 image data
              } else {
                console.log("No image found in the clipboard.");
              }
            })
            .catch((err) => {
              console.error(
                "Failed to retrieve base64 image from clipboard: ",
                err
              );
            });
        }

        function init(customConfirmAction,overlayOptions) {
          window.addEventListener("beforeunload", stopCamera);
          getElements();
          captureBtn.addEventListener("click", captureImage);
          confirmBtn.addEventListener("click", handleConfirm);
          retakeBtn.addEventListener("click", retakePicture);
          startCamera();
          confirmAction = customConfirmAction;

          if (overlayOptions != null) {
            showOverlay =
              overlayOptions.display != null ? overlayOptions.display : true;
            overlayColor = overlayOptions.color || "rgba(0,0,0,0.5)";
          }
          // Call the updateOverlay function initially
          updateOverlay();
          window.addEventListener("load", updateOverlayColor);
          //overlayColorPicker.addEventListener("input", updateOverlayColor);

          // if (options && options.showOverlay !== undefined) {
          //   showOverlay = options.showOverlay;
          // }
          // if (options && options.overlayColor) {
          //   overlayColor = options.overlayColor;
          // }

          // updateOverlay();
          updateOverlayColor();

        }

        // Public functions and properties
        return {
          initialize: init,
          startCamera: startCamera,
          stopCamera:stopCamera,
          retake:retakePicture
        };
      })();

      // Usage
      CameraCaptureModule.initialize(confirmAction,overlayOptions);

    </script>
  </body>
</html>
